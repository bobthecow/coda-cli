#!/usr/bin/env python
#
# Copyright 2011 Justin Hileman - http://justinhileman.com
#
"""
coda - CLI integration for Panic's Coda

This tool provides CLI integration for Coda. You can open files and directories:

    coda foo.html
    coda foo.html bar.html
    coda ./

You can edit a file and wait for it to close (-w/--wait)... This is really
important if you plan on making coda your default $EDITOR. Now you can use
Coda for writing Git or SVN commit messages:

    export EDITOR='coda -w'

In addition to knowing how to wait, coda plays nice with pipes. You can do
interesting things like this:

    echo 'foo' | coda
    echo 'bar' | coda >> out.txt
    coda >> somefile.html

Note that piping output from coda implies --wait.

Usage:

    coda --help
"""
import sys, os, time, commands, optparse, signal
from tempfile import mkstemp
from pipes import quote

version = '0.99.1'
bundle_id = 'com.panic.Coda'

parser = optparse.OptionParser(
    usage='Usage: %prog [options] [file ...]',
    epilog="To read input from stdin, use a pipe or pass `-` for [file]               Piping output from coda implies `-w`."
)
opts = (
    ('-w', '--wait', {'action': 'store_true', 'default': False, 'help': 'wait for file to be closed'}),
    ('-d', '--change-dir', {'action': 'store_true', 'dest': 'chdir', 'default': False, 'help': "change Coda's working directory"}),
    ('-n', '--new-window', {'action': 'store_true', 'dest': 'new_window', 'default': False, 'help': "open in a new window"}),
    ('--ls-tabs', {'action': 'store_true', 'dest': 'lstabs', 'default': False, 'help': 'show all open tabs'}),
    ('--version', {'action': 'store_true', 'default': False, 'help': 'print version information and quit'}),
)
for opt in opts:
    parser.add_option(*opt[:-1], **opt[-1])
parser.version = "%%prog: %s" % version

(options, files) = parser.parse_args()

# handle Ctrl+c gracefully
signal.signal(signal.SIGINT, lambda x,y: sys.exit(1))

def osascript(scpt):
    return commands.getoutput("osascript<<ENDSCRIPT\n%s\nENDSCRIPT\n:" % scpt)

def coda_is_running():
    return osascript("tell application \"System Events\" to (count (every process whose creator type is \"TStu\")) as boolean") == "true"

def open_tabs():
    scpt =  """
            set AppleScript's text item delimiters to "\n"
            tell application "Coda"
                return file path of every editor of every split of every tab of every document as text
            end tell
            """
    if coda_is_running():
        return [os.path.realpath(tab) for tab in filter(lambda a: a != "missing value", osascript(scpt).rstrip("\n").split("\n"))]
    else:
        return None

def new_tab_with_contents(text):
    scpt =  """
            tell application "Coda" to tell first document
                make new tab
                tell current editor to set contents to "%s"
            end tell
            """
    osascript(scpt % text.replace('\\', '\\\\').replace('"', '\\"'))

def read_stdin():
    if sys.stdin.isatty(): # not a pipe, wait for more stdin
        sys.stderr.write("coda: Reading from stdin... (press CTRL-D to proceed)\n")
    return sys.stdin.read()

from_stdin = ('-' in files or not sys.stdin.isatty())
to_stdout  = (not sys.stdout.isatty())
tempfile   = None

if options.version:
    parser.print_version()
    exit()

if options.lstabs:
    tabs = open_tabs()
    if tabs:
        print "\n".join(tabs)
    exit()

if options.new_window and coda_is_running():
    osascript("tell application \"Coda\" to make new document")

if to_stdout:
    options.wait = True
    if from_stdin or not files:
        (fd, tempfile) = mkstemp(prefix='coda ')
        if '-' in files:
            files[files.index('-')] = tempfile
        else:
            files.append(tempfile)

if not files:
    os.system('open -b %s' % bundle_id)
    exit()

if from_stdin and to_stdout:
    open(tempfile, 'w').write(read_stdin())

return_to = None
if options.wait:
    scpt =  """
            tell application "System Events"
                return name of first application process whose frontmost is true
            end tell
            """
    return_to = osascript(scpt)

stdin_text = None
if '-' in files:
    stdin_text = read_stdin()

for i, name in enumerate(files):
    if name == '-':
        new_tab_with_contents(stdin_text)
    else:
        files[i] = file = os.path.realpath(name)
        if not os.path.exists(file):
            os.system('mkdir -p %s' % quote(os.path.dirname(file)))
            os.system('touch %s' % quote(file))
        os.system('open -b %s %s' % (bundle_id, quote(file)))

if options.chdir:
    plen = len(os.path.commonprefix(files))
    path = os.path.commonprefix([f[:plen].rsplit("/", 1)[0] for f in files])
    if not os.path.isdir(path):
        path = os.path.dirname(path)
    os.system('open -b %s %s' % (bundle_id, quote(path)))

if options.wait:
    while list(set(files) & set(open_tabs())):
        time.sleep(.5)
    if to_stdout:
        sys.stdout.write("\n".join([open(f).read() for f in files]))
    elif tempfile:
        sys.stderr.write("File written to %s" % quote(tempfile))
    if return_to:
        osascript("tell application \"%s\" to activate" % return_to)